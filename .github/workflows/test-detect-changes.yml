# Local-only workflow for testing path detection logic with `act`
#
# Usage (via wrapper script):
#   ./scripts/test-detect-changes.sh              # compare HEAD vs master
#   ./scripts/test-detect-changes.sh origin/main   # compare HEAD vs specific base
#
# Direct act usage:
#   act workflow_dispatch -W .github/workflows/test-detect-changes.yml \
#       --input base=master -j detect-changes
#
# This reuses the exact same path-filters.yml as the real build workflow,
# ensuring local testing matches CI behaviour.
#
# NOTE: Content-aware pyproject.toml classification (build-relevant vs
# metadata-only) only runs in the real CI workflow. This test shows the
# raw path-filter result for pyproject.toml.

name: "[Local] Test detect-changes"

on:
  workflow_dispatch:
    inputs:
      base:
        description: 'Base branch/commit to compare against'
        required: true
        default: 'master'

jobs:
  detect-changes:
    name: Detect code changes
    runs-on: ubuntu-latest
    outputs:
      # NOTE: needs-build here treats any pyproject.toml change as build-triggering.
      # The real CI workflow classifies pyproject.toml by content (see build-publish_to_pypi.yml).
      # SYNC-NOTE: update if needs-build categories change in build-publish_to_pypi.yml
      needs-build: ${{ steps.filter.outputs.fortran == 'true' || steps.filter.outputs.python == 'true' || steps.filter.outputs.util == 'true' || steps.filter.outputs.build == 'true' || steps.filter.outputs.pyproject == 'true' || steps.filter.outputs.ci == 'true' || steps.filter.outputs.tests == 'true' }}
      fortran-changed: ${{ steps.filter.outputs.fortran }}
      python-changed: ${{ steps.filter.outputs.python }}
      util-changed: ${{ steps.filter.outputs.util }}
      build-changed: ${{ steps.filter.outputs.build }}
      pyproject-changed: ${{ steps.filter.outputs.pyproject }}
      ci-changed: ${{ steps.filter.outputs.ci }}
      tests-changed: ${{ steps.filter.outputs.tests }}
      docs-changed: ${{ steps.filter.outputs.docs }}
      site-changed: ${{ steps.filter.outputs.site }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: dorny/paths-filter@v3
        id: filter
        with:
          base: ${{ inputs.base }}
          list-files: csv
          filters: .github/path-filters.yml

      - name: Warn about pyproject.toml limitation
        if: steps.filter.outputs.pyproject == 'true'
        run: |
          echo "::warning::pyproject.toml changed. This local test treats ALL pyproject.toml changes as build-triggering. The real CI classifies by content (build-system/cibuildwheel -> multiplatform, dependencies -> single-platform, tooling -> no build)."

      - name: Show results
        run: |
          echo "=== Changed Files ==="
          echo "fortran files:   ${{ steps.filter.outputs.fortran_files }}"
          echo "python files:    ${{ steps.filter.outputs.python_files }}"
          echo "util files:      ${{ steps.filter.outputs.util_files }}"
          echo "build files:     ${{ steps.filter.outputs.build_files }}"
          echo "pyproject files: ${{ steps.filter.outputs.pyproject_files }}"
          echo "ci files:        ${{ steps.filter.outputs.ci_files }}"
          echo "tests files:     ${{ steps.filter.outputs.tests_files }}"
          echo "docs files:      ${{ steps.filter.outputs.docs_files }}"
          echo "site files:      ${{ steps.filter.outputs.site_files }}"
          echo ""
          echo "=== Category Results ==="
          echo "fortran:   ${{ steps.filter.outputs.fortran }}"
          echo "python:    ${{ steps.filter.outputs.python }}"
          echo "util:      ${{ steps.filter.outputs.util }}"
          echo "build:     ${{ steps.filter.outputs.build }}"
          echo "pyproject: ${{ steps.filter.outputs.pyproject }}"
          echo "ci:        ${{ steps.filter.outputs.ci }}"
          echo "tests:     ${{ steps.filter.outputs.tests }}"
          echo "docs:      ${{ steps.filter.outputs.docs }}"
          echo "site:      ${{ steps.filter.outputs.site }}"

  show-build-decision:
    name: Show build decision
    runs-on: ubuntu-latest
    needs: [detect-changes]
    steps:
      - name: Build decision summary
        env:
          NEEDS_BUILD: ${{ needs.detect-changes.outputs.needs-build }}
          FORTRAN: ${{ needs.detect-changes.outputs.fortran-changed }}
          PYTHON: ${{ needs.detect-changes.outputs.python-changed }}
          UTIL: ${{ needs.detect-changes.outputs.util-changed }}
          BUILD: ${{ needs.detect-changes.outputs.build-changed }}
          PYPROJECT: ${{ needs.detect-changes.outputs.pyproject-changed }}
          CI: ${{ needs.detect-changes.outputs.ci-changed }}
          TESTS: ${{ needs.detect-changes.outputs.tests-changed }}
          DOCS: ${{ needs.detect-changes.outputs.docs-changed }}
          SITE: ${{ needs.detect-changes.outputs.site-changed }}
        run: |
          echo "=== Build Decision ==="
          echo "needs-build: $NEEDS_BUILD"
          echo ""

          # Determine multiplatform requirement
          # (fortran or build-system â€” NOT ci workflow tweaks)
          NEEDS_MULTIPLATFORM=false
          if [[ "$FORTRAN" == "true" ]] || [[ "$BUILD" == "true" ]]; then
            NEEDS_MULTIPLATFORM=true
          fi
          echo "needs-multiplatform: $NEEDS_MULTIPLATFORM"

          if [[ "$PYPROJECT" == "true" ]]; then
            echo ""
            echo "NOTE: pyproject.toml changed. In real CI, content classification"
            echo "determines whether this triggers multiplatform (build-system/"
            echo "cibuildwheel), single-platform (dependencies), or no build"
            echo "(tooling/optional-deps). This local test cannot classify content."
          fi
          echo ""

          if [[ "$NEEDS_BUILD" == "true" ]]; then
            # NOTE: Simplified reproduction of determine_matrix logic.
            # Update if build-publish_to_pypi.yml changes tier rules.
            echo "--- Draft PR ---"
            if [[ "$FORTRAN" == "true" ]]; then
              echo "  platforms: reduced (3), test tier: core"
            elif [[ "$BUILD" == "true" ]]; then
              echo "  platforms: reduced (3), test tier: cfg"
            else
              echo "  platforms: minimal (1), test tier: smoke"
            fi

            echo "--- Ready PR ---"
            if [[ "$NEEDS_MULTIPLATFORM" == "true" ]]; then
              echo "  platforms: reduced (3), test tier: standard"
            elif [[ "$PYTHON" == "true" ]] || [[ "$UTIL" == "true" ]]; then
              echo "  platforms: minimal (1), test tier: standard"
            else
              echo "  platforms: minimal (1), test tier: smoke"
            fi
          else
            echo "(no build required - PR gate passes without building)"
          fi

          echo ""
          echo "=== What would trigger in CI ==="
          TRIGGERED=false
          if [[ "$DOCS" == "true" ]]; then echo "- docs build (pages-deploy.yml)"; TRIGGERED=true; fi
          if [[ "$SITE" == "true" ]]; then echo "- site deploy (pages-deploy.yml)"; TRIGGERED=true; fi
          if [[ "$NEEDS_BUILD" == "true" ]]; then echo "- wheel build (build_wheels + build_umep)"; TRIGGERED=true; fi
          if [[ "$TRIGGERED" == "false" ]]; then echo "- nothing (all skipped)"; fi
