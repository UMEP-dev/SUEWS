name: Cleanup docs preview

# Clean up GitHub Pages preview directories when PRs are closed
# This prevents accumulation of stale preview content
#
# IMPORTANT: This workflow uses step outputs to control deployment.
# The `exit 0` in a shell script only exits that step - it does NOT
# prevent subsequent steps from running. We use outputs and `if` conditions.

on:
  pull_request:
    types: [closed]

# Serialise with main docs deployment to avoid conflicts
concurrency:
  group: pages-deploy
  cancel-in-progress: false

jobs:
  cleanup:
    name: Remove PR preview
    runs-on: ubuntu-latest

    permissions:
      pages: write
      id-token: write

    environment:
      name: github-pages-preview

    steps:
      - name: Fetch and clean preview content
        id: cleanup
        run: |
          mkdir -p _site

          PR_NUM="${{ github.event.pull_request.number }}"
          echo "Cleaning up preview for PR #${PR_NUM}"

          # Fetch existing site content from the custom domain
          # Note: Use suews.io (not umep-dev.github.io which redirects)
          if timeout 60 wget -q -r -np -nH -P _site \
               --reject "index.html*" \
               https://suews.io/ 2>&1; then
            echo "✓ Fetched existing site content"
          else
            echo "⚠ Could not fetch existing content - skipping cleanup"
            echo "should_deploy=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Check if preview directory exists
          if [ -d "_site/preview/pr-${PR_NUM}" ]; then
            echo "Removing _site/preview/pr-${PR_NUM}/"
            rm -rf "_site/preview/pr-${PR_NUM}"
            echo "✓ Preview directory removed"

            # Check if preview parent directory is empty and clean up
            if [ -d "_site/preview" ] && [ -z "$(ls -A _site/preview)" ]; then
              echo "Removing empty preview directory"
              rm -rf "_site/preview"
            fi

            touch _site/.nojekyll

            # Sanity check: ensure we have meaningful content before deploying
            SITE_SIZE=$(du -sb _site | cut -f1)
            echo "Site size: ${SITE_SIZE} bytes"
            if [ "$SITE_SIZE" -lt 10000 ]; then
              echo "⚠ Site size too small (${SITE_SIZE} bytes) - refusing to deploy to prevent wipe"
              echo "should_deploy=false" >> $GITHUB_OUTPUT
              exit 0
            fi

            echo "should_deploy=true" >> $GITHUB_OUTPUT
          else
            echo "No preview found for PR #${PR_NUM} - nothing to clean up"
            echo "should_deploy=false" >> $GITHUB_OUTPUT
          fi

      - name: Configure Pages
        if: steps.cleanup.outputs.should_deploy == 'true'
        uses: actions/configure-pages@v5

      - name: Upload Pages artifact
        if: steps.cleanup.outputs.should_deploy == 'true'
        uses: actions/upload-pages-artifact@v3
        with:
          path: _site

      - name: Deploy to GitHub Pages
        if: steps.cleanup.outputs.should_deploy == 'true'
        uses: actions/deploy-pages@v4
