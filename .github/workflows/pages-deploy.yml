name: GitHub Pages Deploy

# RELIABLE GITHUB PAGES DEPLOYMENT
# =================================
# Deploys static content from site/ to GitHub Pages.
# - Push to master: Deploy production site
# - Pull request: Add preview to /preview/pr-{NUMBER}/
# - Manual dispatch: Force redeploy
#
# Previews are ephemeral - each deployment includes full site from repo.
# No wget required; repo content is the single source of truth.

on:
  push:
    branches: [master]
    paths:
      - 'site/**'
      - '.github/workflows/pages-deploy.yml'

  pull_request:
    paths:
      - 'site/**'
      - '.github/workflows/pages-deploy.yml'

  workflow_dispatch:

concurrency:
  group: pages-deploy
  cancel-in-progress: false

permissions:
  contents: read
  pages: write
  id-token: write
  pull-requests: write

jobs:
  deploy:
    name: Deploy to GitHub Pages
    runs-on: ubuntu-latest

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - uses: actions/checkout@v4

      - name: Build site
        run: |
          mkdir -p _site

          # Copy production content
          cp -r site/* _site/

          # Add PR preview if applicable
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            PR_NUM="${{ github.event.pull_request.number }}"
            mkdir -p "_site/preview/pr-${PR_NUM}"
            cp -r site/* "_site/preview/pr-${PR_NUM}/"
            echo "Preview created at /preview/pr-${PR_NUM}/"
          fi

          touch _site/.nojekyll
          echo "Site ready: $(find _site -type f | wc -l) files"

      - uses: actions/configure-pages@v5
      - uses: actions/upload-pages-artifact@v3
        with:
          path: _site
      - uses: actions/deploy-pages@v4
        id: deployment

      - name: Comment preview URL
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.issue.number;
            const body = `## Preview Deployed

            **Preview:** https://suews.io/preview/pr-${prNumber}/

            > **Note:** This preview is ephemeral. It will be lost when:
            > - Another PR with \`site/\` changes is pushed
            > - Changes are merged to master
            > - A manual workflow dispatch runs
            >
            > To restore, push any commit to this PR.`;

            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber
            });

            const botComment = comments.data.find(c =>
              c.user.type === 'Bot' && c.body.includes('Preview Deployed')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body
              });
            }
