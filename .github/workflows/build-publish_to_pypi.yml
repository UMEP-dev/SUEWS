name: Build and Publish Python wheels to PyPI and TestPyPI

# Builds and deploys SUEWS/SuPy Python wheels.
#
# Triggers:
#   schedule  -- Nightly 2 AM UTC: tag YYYY.M.D.dev -> build -> TestPyPI
#   tags      -- Any tag push: full matrix build -> PyPI (non-dev) or TestPyPI (dev)
#   PR        -- Validation only with adaptive matrix (draft=minimal, ready=reduced)
#   merge_group -- Merge queue validation (reduced matrix)
#   dispatch  -- Manual with configurable matrix, deploy target, UMEP toggle, test tier
#
# Dual-build strategy:
#   Standard -- NumPy >=2.0, all Python versions. pip install supy
#   UMEP     -- NumPy 1.x (QGIS 3.40 LTR), cp312 only. Version X.Y.Zrc1 (production)
#               or X.Y.Z.dev1 (nightly). Pre-release tag keeps it hidden from default pip.
#
# Nightly version: Tag YYYY.M.D.dev created BEFORE build for version consistency.
# See get_ver_git.py for version string logic, .github/path-filters.yml for categories.

on:
  push:
    tags:
      - '*'

  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    # No path filters -- branch protection requires this job; detect-changes handles filtering

  merge_group:
    types: [checks_requested]

  schedule:
    - cron: '0 2 * * *'

  workflow_dispatch:
    inputs:
      matrix_config:
        description: 'Build matrix (custom = use toggles below)'
        required: true
        default: 'full'
        type: choice
        options:
          - full
          - pr
          - minimal
          - custom

      # Platform toggles (custom only)
      plat_linux:
        description: '[custom] Linux (manylinux x86_64)'
        type: boolean
        default: true
      plat_macos_intel:
        description: '[custom] macOS Intel (x86_64)'
        type: boolean
        default: false
      plat_macos_arm:
        description: '[custom] macOS ARM (arm64)'
        type: boolean
        default: true
      plat_windows:
        description: '[custom] Windows (AMD64)'
        type: boolean
        default: true

      # Python toggles (custom only)
      py39:
        description: '[custom] Python 3.9'
        type: boolean
        default: true
      py310:
        description: '[custom] Python 3.10'
        type: boolean
        default: false
      py311:
        description: '[custom] Python 3.11'
        type: boolean
        default: false
      py312:
        description: '[custom] Python 3.12'
        type: boolean
        default: false
      py313:
        description: '[custom] Python 3.13'
        type: boolean
        default: false
      py314:
        description: '[custom] Python 3.14'
        type: boolean
        default: true

      deploy_target:
        description: 'Deployment target (PyPI requires tagged release)'
        required: true
        default: 'none'
        type: choice
        options:
          - none
          - testpypi
      include_umep:
        description: 'Build UMEP variant (NumPy 1.x compatible)'
        required: true
        default: true
        type: boolean
      test_tier:
        description: 'Test suite level'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - standard
          - core
          - cfg
          - smoke

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  verify-release-tag:
    name: Verify tag is on master
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    outputs:
      on-master: ${{ steps.check.outputs.on-master }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - id: check
        run: |
          if git merge-base --is-ancestor $GITHUB_SHA refs/remotes/origin/master; then
            echo "on-master=true" >> $GITHUB_OUTPUT
          else
            echo "::warning::Tag ${{ github.ref_name }} not on master â€” skipping release"
            echo "on-master=false" >> $GITHUB_OUTPUT
          fi

  create_nightly_tag:
    name: Create nightly tag for scheduled builds
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Create and push nightly tag
        run: |
          set -e
          YEAR=$(date -u +%Y)
          MONTH=$(date -u +%-m)
          DAY=$(date -u +%-d)
          DEV_TAG="${YEAR}.${MONTH}.${DAY}.dev"
          echo "Creating dev tag: ${DEV_TAG}"

          git config user.name github-actions
          git config user.email github-actions@github.com

          if git ls-remote --tags origin | grep -q "refs/tags/${DEV_TAG}"; then
            echo "Tag ${DEV_TAG} already exists on remote, skipping"
          else
            git tag -a "${DEV_TAG}" -m "Nightly build ${YEAR}-${MONTH}-${DAY}"
            git push origin "${DEV_TAG}"
            echo "Successfully created and pushed tag ${DEV_TAG}"
          fi

  detect-changes:
    name: Detect code changes
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' || github.event_name == 'merge_group'
    outputs:
      needs-build: ${{ steps.decide.outputs.needs-build }}
      needs-umep-build: ${{ steps.decide.outputs.needs-umep-build }}
      fortran-changed: ${{ steps.filter.outputs.fortran }}
      python-changed: ${{ steps.decide.outputs.python-changed }}
      util-changed: ${{ steps.filter.outputs.util }}
      build-changed: ${{ steps.decide.outputs.build-changed }}
      ci-changed: ${{ steps.filter.outputs.ci }}
      tests-changed: ${{ steps.filter.outputs.tests }}
      docs-changed: ${{ steps.filter.outputs.docs }}
      site-changed: ${{ steps.filter.outputs.site }}
      fortran-files: ${{ steps.filter.outputs.fortran_files }}
      python-files: ${{ steps.filter.outputs.python_files }}
      util-files: ${{ steps.filter.outputs.util_files }}
      build-files: ${{ steps.filter.outputs.build_files }}
      ci-files: ${{ steps.filter.outputs.ci_files }}
      tests-files: ${{ steps.filter.outputs.tests_files }}
      docs-files: ${{ steps.filter.outputs.docs_files }}
      site-files: ${{ steps.filter.outputs.site_files }}
      pyproject-files: ${{ steps.filter.outputs.pyproject_files }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for pyproject.toml content classification

      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: .github/path-filters.yml
          list-files: 'json'

      # Content-aware: only [build-system] / [tool.cibuildwheel] need multiplatform builds
      - name: Classify pyproject.toml changes
        id: classify-pyproject
        if: steps.filter.outputs.pyproject == 'true'
        env:
          BASE_SHA: ${{ github.event.pull_request.base.sha || github.event.merge_group.base_sha }}
        run: python3 .github/scripts/classify_pyproject.py

      - name: Compute build decision
        id: decide
        run: |
          BUILD_CHANGED=false
          if [[ "${{ steps.filter.outputs.build }}" == "true" ]] || \
             [[ "${{ steps.classify-pyproject.outputs.build_relevant || 'false' }}" == "true" ]]; then
            BUILD_CHANGED=true
          fi
          echo "build-changed=$BUILD_CHANGED" >> $GITHUB_OUTPUT

          PYTHON_CHANGED=false
          if [[ "${{ steps.filter.outputs.python }}" == "true" ]] || \
             [[ "${{ steps.classify-pyproject.outputs.package_relevant || 'false' }}" == "true" ]]; then
            PYTHON_CHANGED=true
          fi
          echo "python-changed=$PYTHON_CHANGED" >> $GITHUB_OUTPUT

          FORTRAN="${{ steps.filter.outputs.fortran }}"
          UTIL="${{ steps.filter.outputs.util }}"
          CI="${{ steps.filter.outputs.ci }}"
          TESTS="${{ steps.filter.outputs.tests }}"

          NEEDS_BUILD=false
          if [[ "$FORTRAN" == "true" ]] || \
             [[ "$PYTHON_CHANGED" == "true" ]] || \
             [[ "$UTIL" == "true" ]] || \
             [[ "$BUILD_CHANGED" == "true" ]] || \
             [[ "$CI" == "true" ]] || \
             [[ "$TESTS" == "true" ]]; then
            NEEDS_BUILD=true
          fi
          echo "needs-build=$NEEDS_BUILD" >> $GITHUB_OUTPUT

          # UMEP build only when compiled extension ABI may differ
          NEEDS_UMEP_BUILD=false
          if [[ "$FORTRAN" == "true" ]] || \
             [[ "$BUILD_CHANGED" == "true" ]]; then
            NEEDS_UMEP_BUILD=true
          fi
          echo "needs-umep-build=$NEEDS_UMEP_BUILD" >> $GITHUB_OUTPUT

  determine_matrix:
    name: Determine build matrix
    runs-on: ubuntu-latest
    needs: [detect-changes]
    if: always() && (needs.detect-changes.result == 'success' || needs.detect-changes.result == 'skipped')
    outputs:
      buildplat: ${{ steps.set-matrix.outputs.buildplat }}
      python: ${{ steps.set-matrix.outputs.python }}
      umep_buildplat: ${{ steps.set-matrix.outputs.umep_buildplat }}
      umep_python: ${{ steps.set-matrix.outputs.umep_python }}
      test_tier: ${{ steps.set-matrix.outputs.test_tier }}
    steps:
      - uses: actions/checkout@v4
        with:
          sparse-checkout: .github/scripts
          sparse-checkout-cone-mode: false

      - name: Set matrix based on trigger type
        id: set-matrix
        env:
          EVENT_NAME: ${{ github.event_name }}
          IS_DRAFT: ${{ github.event.pull_request.draft }}
          FORTRAN_CHANGED: ${{ needs.detect-changes.outputs.fortran-changed || 'false' }}
          PYTHON_CHANGED: ${{ needs.detect-changes.outputs.python-changed || 'false' }}
          UTIL_CHANGED: ${{ needs.detect-changes.outputs.util-changed || 'false' }}
          BUILD_CHANGED: ${{ needs.detect-changes.outputs.build-changed || 'false' }}
          INPUT_MATRIX_CONFIG: ${{ inputs.matrix_config }}
          INPUT_PLAT_LINUX: ${{ inputs.plat_linux }}
          INPUT_PLAT_MACOS_INTEL: ${{ inputs.plat_macos_intel }}
          INPUT_PLAT_MACOS_ARM: ${{ inputs.plat_macos_arm }}
          INPUT_PLAT_WINDOWS: ${{ inputs.plat_windows }}
          INPUT_PY39: ${{ inputs.py39 }}
          INPUT_PY310: ${{ inputs.py310 }}
          INPUT_PY311: ${{ inputs.py311 }}
          INPUT_PY312: ${{ inputs.py312 }}
          INPUT_PY313: ${{ inputs.py313 }}
          INPUT_PY314: ${{ inputs.py314 }}
          INPUT_TEST_TIER: ${{ inputs.test_tier }}
          GITHUB_REF: ${{ github.ref }}
        run: bash .github/scripts/determine-matrix.sh

  post-ci-summary:
    name: Post CI summary comment
    runs-on: ubuntu-latest
    needs: [detect-changes, determine_matrix]
    if: >-
      github.event_name == 'pull_request' &&
      needs.detect-changes.result == 'success' &&
      needs.determine_matrix.result == 'success'
    permissions:
      pull-requests: write
      issues: write
    steps:
      - uses: actions/checkout@v4
        with:
          sparse-checkout: .github/scripts
          sparse-checkout-cone-mode: false

      - name: Post or update CI summary comment
        uses: actions/github-script@v7
        env:
          FORTRAN_CHANGED: ${{ needs.detect-changes.outputs.fortran-changed }}
          PYTHON_CHANGED: ${{ needs.detect-changes.outputs.python-changed }}
          UTIL_CHANGED: ${{ needs.detect-changes.outputs.util-changed }}
          BUILD_CHANGED: ${{ needs.detect-changes.outputs.build-changed }}
          CI_CHANGED: ${{ needs.detect-changes.outputs.ci-changed }}
          TESTS_CHANGED: ${{ needs.detect-changes.outputs.tests-changed }}
          DOCS_CHANGED: ${{ needs.detect-changes.outputs.docs-changed }}
          SITE_CHANGED: ${{ needs.detect-changes.outputs.site-changed }}
          FORTRAN_FILES: ${{ needs.detect-changes.outputs.fortran-files || '[]' }}
          PYTHON_FILES: ${{ needs.detect-changes.outputs.python-files || '[]' }}
          UTIL_FILES: ${{ needs.detect-changes.outputs.util-files || '[]' }}
          BUILD_FILES: ${{ needs.detect-changes.outputs.build-files || '[]' }}
          CI_FILES: ${{ needs.detect-changes.outputs.ci-files || '[]' }}
          TESTS_FILES: ${{ needs.detect-changes.outputs.tests-files || '[]' }}
          DOCS_FILES: ${{ needs.detect-changes.outputs.docs-files || '[]' }}
          SITE_FILES: ${{ needs.detect-changes.outputs.site-files || '[]' }}
          PYPROJECT_FILES: ${{ needs.detect-changes.outputs.pyproject-files || '[]' }}
          NEEDS_BUILD: ${{ needs.detect-changes.outputs.needs-build }}
          NEEDS_UMEP_BUILD: ${{ needs.detect-changes.outputs.needs-umep-build }}
          TEST_TIER: ${{ needs.determine_matrix.outputs.test_tier }}
          BUILDPLAT_JSON: ${{ needs.determine_matrix.outputs.buildplat }}
          PYTHON_JSON: ${{ needs.determine_matrix.outputs.python }}
          COMMIT_SHA: ${{ github.sha }}
        with:
          script: |
            const script = require('./.github/scripts/post-ci-summary.js');
            await script({ github, context });

  build_wheels:
    name: Build standard wheels
    needs: [determine_matrix, create_nightly_tag, detect-changes, verify-release-tag]
    if: |
      always() &&
      needs.determine_matrix.result == 'success' &&
      (needs.create_nightly_tag.result == 'success' || needs.create_nightly_tag.result == 'skipped') &&
      (needs.detect-changes.result == 'skipped' || needs.detect-changes.outputs.needs-build == 'true') &&
      (needs.verify-release-tag.result == 'skipped' || needs.verify-release-tag.outputs.on-master == 'true')
    uses: ./.github/workflows/build-wheels-reusable.yml
    with:
      buildplat_json: ${{ needs.determine_matrix.outputs.buildplat }}
      python_json: ${{ needs.determine_matrix.outputs.python }}
      test_tier: ${{ needs.determine_matrix.outputs.test_tier }}
      is_umep_variant: 'false'
      wheel_name_suffix: ''
      is_testpypi_build: ${{ github.event_name == 'schedule' || (startsWith(github.ref, 'refs/tags/') && contains(github.ref, 'dev')) }}
      enable_dts: ${{ github.event_name == 'schedule' || startsWith(github.ref, 'refs/tags/') }}

  build_umep:
    name: Build UMEP wheels
    needs: [determine_matrix, create_nightly_tag, detect-changes, verify-release-tag]
    # PRs skip UMEP unless compiled extension ABI may differ (fortran/build-system)
    if: |
      always() &&
      needs.determine_matrix.result == 'success' &&
      (needs.create_nightly_tag.result == 'success' || needs.create_nightly_tag.result == 'skipped') &&
      (needs.detect-changes.result == 'skipped' || needs.detect-changes.outputs.needs-umep-build == 'true') &&
      (needs.verify-release-tag.result == 'skipped' || needs.verify-release-tag.outputs.on-master == 'true') &&
      (github.event_name != 'workflow_dispatch' || inputs.include_umep == true)
    uses: ./.github/workflows/build-wheels-reusable.yml
    with:
      buildplat_json: ${{ needs.determine_matrix.outputs.umep_buildplat }}
      python_json: ${{ needs.determine_matrix.outputs.umep_python }}
      test_tier: ${{ needs.determine_matrix.outputs.test_tier }}
      is_umep_variant: 'true'
      wheel_name_suffix: '-umep'
      is_testpypi_build: ${{ github.event_name == 'schedule' || (startsWith(github.ref, 'refs/tags/') && contains(github.ref, 'dev')) }}
      enable_dts: ${{ github.event_name == 'schedule' || startsWith(github.ref, 'refs/tags/') }}

  # Single consolidated check for branch protection (always runs for PRs/merge queue)
  pr-gate:
    name: PR build validation
    runs-on: ubuntu-latest
    if: always() && (github.event_name == 'pull_request' || github.event_name == 'merge_group')
    needs: [build_wheels, build_umep, detect-changes]
    steps:
      - uses: actions/checkout@v4
        with:
          sparse-checkout: .github/scripts
          sparse-checkout-cone-mode: false

      - name: Check build results
        env:
          DETECT_CHANGES_RESULT: ${{ needs.detect-changes.result }}
          BUILD_WHEELS_RESULT: ${{ needs.build_wheels.result }}
          BUILD_UMEP_RESULT: ${{ needs.build_umep.result }}
          NEEDS_BUILD: ${{ needs.detect-changes.outputs.needs-build }}
          NEEDS_UMEP_BUILD: ${{ needs.detect-changes.outputs.needs-umep-build }}
        run: bash .github/scripts/pr-gate.sh

  deploy_testpypi:
    name: Publish to TestPyPI
    runs-on: ubuntu-latest
    needs:
      - determine_matrix
      - build_wheels
      - create_nightly_tag
      - verify-release-tag
    # Deploy for nightly/dev-tag/manual-dispatch even if some platforms fail
    if: |
      always() &&
      needs.build_wheels.result != 'cancelled' &&
      (needs.create_nightly_tag.result == 'success' || needs.create_nightly_tag.result == 'skipped') &&
      (needs.verify-release-tag.result == 'skipped' || needs.verify-release-tag.outputs.on-master == 'true') &&
      (
        github.event_name == 'schedule' ||
        (startsWith(github.ref, 'refs/tags/') && contains(github.ref, 'dev')) ||
        (github.event_name == 'workflow_dispatch' && inputs.deploy_target == 'testpypi')
      )

    permissions:
      id-token: write

    steps:
      - name: Download all wheels for TestPyPI
        uses: actions/download-artifact@v4
        with:
          path: dist/
          merge-multiple: true

      - name: Publish wheels to Test PyPI
        uses: pypa/gh-action-pypi-publish@release/v1.8
        with:
          packages-dir: dist/
          verbose: true
          skip-existing: true
          repository-url: https://test.pypi.org/legacy/

  deploy_pypi:
    name: Publish all wheels to PyPI
    runs-on: ubuntu-latest
    needs:
      - determine_matrix
      - build_wheels
      - build_umep
      - create_nightly_tag
      - verify-release-tag
    # Production tags only: both standard and UMEP builds must succeed
    if: |
      always() &&
      startsWith(github.ref, 'refs/tags') &&
      !contains(github.ref, 'dev') &&
      needs.build_wheels.result == 'success' &&
      needs.build_umep.result == 'success' &&
      (needs.create_nightly_tag.result == 'success' || needs.create_nightly_tag.result == 'skipped') &&
      (needs.verify-release-tag.result == 'skipped' || needs.verify-release-tag.outputs.on-master == 'true')

    permissions:
      id-token: write

    steps:
      - name: Download all wheels (standard + UMEP)
        uses: actions/download-artifact@v4
        with:
          path: dist/
          merge-multiple: true

      - name: Publish all wheels to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1.8
        with:
          packages-dir: dist/
          verbose: true
          skip-existing: true

  create_github_release:
    name: Create GitHub Release (triggers Zenodo)
    runs-on: ubuntu-latest
    needs:
      - deploy_pypi
    if: always() && needs.deploy_pypi.result == 'success'
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract version from tag
        id: get_version
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Prepare release notes
        id: release_notes
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"
          RELEASE_FILE=".github/releases/${VERSION}.md"

          if [ -f "$RELEASE_FILE" ]; then
            echo "Using pre-prepared release notes: $RELEASE_FILE"
            cp "$RELEASE_FILE" release_notes.md
          else
            echo "No pre-prepared release notes found, extracting from CHANGELOG"
            YEAR=$(echo $VERSION | cut -d. -f1)
            MONTH=$(echo $VERSION | cut -d. -f2)
            DAY=$(echo $VERSION | cut -d. -f3)

            MONTH_NAME=$(date -d "$YEAR-$MONTH-$DAY" +"%b" 2>/dev/null || date -j -f "%Y-%m-%d" "$YEAR-$MONTH-$DAY" +"%b" 2>/dev/null || echo "")

            CHANGELOG_SECTION=""
            if [ -n "$MONTH_NAME" ]; then
              CHANGELOG_SECTION=$(awk "/^### $DAY $MONTH_NAME $YEAR/,/^### [0-9]/" CHANGELOG.md | sed '$d' || echo "")
              if [ -z "$CHANGELOG_SECTION" ]; then
                DAY_PADDED=$(printf "%02d" $DAY)
                CHANGELOG_SECTION=$(awk "/^### $DAY_PADDED $MONTH_NAME $YEAR/,/^### [0-9]/" CHANGELOG.md | sed '$d' || echo "")
              fi
            fi

            if [ -z "$CHANGELOG_SECTION" ]; then
              CHANGELOG_SECTION="See [CHANGELOG.md](https://github.com/UMEP-dev/SUEWS/blob/master/CHANGELOG.md) for details."
            fi

            cat << EOF > release_notes.md
          ## Installation

          \`\`\`bash
          pip install --upgrade supy
          \`\`\`

          ## Changes

          $CHANGELOG_SECTION

          ## Citation

          This release is automatically archived on Zenodo and assigned a DOI for academic citation. The DOI will appear here once Zenodo processing is complete (usually within a few minutes).

          ## Documentation

          - [User Guide](https://suews.readthedocs.io)
          - [CHANGELOG](https://github.com/UMEP-dev/SUEWS/blob/master/CHANGELOG.md)
          - [GitHub Repository](https://github.com/UMEP-dev/SUEWS)
          EOF
          fi

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"
          TITLE=$(git tag -l --format='%(contents:subject)' "$VERSION" || echo "SUEWS Release")
          gh release create "$VERSION" \
            --title "SUEWS v$VERSION: $TITLE" \
            --notes-file release_notes.md \
            --verify-tag
