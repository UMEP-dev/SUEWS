name: Validate CLAUDE.md

on:
  pull_request:
    paths:
      - 'CLAUDE.md'
      - '.claude/scripts/validate-claude-md.py'
  push:
    branches:
      - master
    paths:
      - 'CLAUDE.md'

jobs:
  validate:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 2  # Need previous commit for comparison

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.x'

    - name: Check CLAUDE.md integrity
      run: |
        echo "üîç Validating CLAUDE.md integrity..."
        python .claude/scripts/validate-claude-md.py

    - name: Check for content reduction
      run: |
        echo "üìä Checking for content reduction..."

        # Get line counts
        CURRENT_LINES=$(wc -l < CLAUDE.md)
        git show HEAD~1:CLAUDE.md > CLAUDE.md.previous 2>/dev/null || echo "First commit" > CLAUDE.md.previous
        PREVIOUS_LINES=$(wc -l < CLAUDE.md.previous)

        echo "Previous version: $PREVIOUS_LINES lines"
        echo "Current version: $CURRENT_LINES lines"

        # Check if this is an intentional restructuring (reference files present)
        REQUIRED_REFS=(
          ".claude/reference/quick-start.md"
          ".claude/reference/testing-guide.md"
          ".claude/reference/config-patterns.md"
          ".claude/reference/maintenance-principles.md"
        )

        ALL_REFS_EXIST=true
        for ref in "${REQUIRED_REFS[@]}"; do
          if [ ! -f "$ref" ]; then
            ALL_REFS_EXIST=false
            break
          fi
        done

        # Calculate reduction percentage
        if [ "$PREVIOUS_LINES" -gt 0 ]; then
          REDUCTION=$((PREVIOUS_LINES - CURRENT_LINES))
          PERCENT=$((REDUCTION * 100 / PREVIOUS_LINES))

          if [ "$PERCENT" -gt 20 ]; then
            if [ "$ALL_REFS_EXIST" = true ]; then
              echo "‚ÑπÔ∏è Large reduction detected ($PERCENT%), but required reference files exist"
              echo "   This appears to be an intentional restructuring (DRY principles)"
              echo "   Content moved to:"
              for ref in "${REQUIRED_REFS[@]}"; do
                echo "   - $ref"
              done
            else
              echo "‚ö†Ô∏è WARNING: CLAUDE.md reduced by $PERCENT% ($REDUCTION lines)"
              echo "This might indicate content loss!"
              exit 1
            fi
          elif [ "$PERCENT" -gt 10 ]; then
            echo "‚ö†Ô∏è Notice: CLAUDE.md reduced by $PERCENT% ($REDUCTION lines)"
          fi
        fi

        echo "‚úÖ Content size check passed"

    - name: Create snapshot on failure
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: claude-md-snapshot-${{ github.sha }}
        path: |
          CLAUDE.md
          CLAUDE.md.previous
          .claude/snapshots/