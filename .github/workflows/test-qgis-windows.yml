name: Test QGIS Windows Compatibility

# ============================================================================
# QGIS WINDOWS TESTING (GH-1035)
# ============================================================================
# This workflow tests supy in a Windows QGIS environment to verify that
# SUEWS errors are handled gracefully without crashing QGIS.
#
# Background: f90wrap's SIGINT handler modification conflicts with Qt's
# signal handlers on Windows, causing QGIS to crash when SUEWS errors occur.
# This workflow validates our fix using OSGeo4W (same as UMEP/QGIS users).
#
# ============================================================================

on:
  # Run on PRs that modify relevant files
  pull_request:
    paths:
      - 'src/supy/_vendor/f90wrap_src/**'
      - 'src/supy_driver/f2py-f90wrap-patched.py'
      - 'test/qgis/**'
      - '.github/workflows/test-qgis-windows.yml'

  # Manual trigger for testing
  workflow_dispatch:

  # Run after nightly builds to validate dev releases
  workflow_run:
    workflows: ["Build and Publish Python wheels to PyPI and TestPyPI"]
    types: [completed]
    branches: [master]

jobs:
  test-qgis-windows:
    runs-on: windows-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install OSGeo4W (QGIS)
        shell: pwsh
        run: |
          # Download OSGeo4W installer
          # Reference: https://trac.osgeo.org/osgeo4w/wiki/CommandLine
          $installerUrl = "https://download.osgeo.org/osgeo4w/v2/osgeo4w-setup.exe"
          $installerPath = "$env:TEMP\osgeo4w-setup.exe"
          Invoke-WebRequest -Uri $installerUrl -OutFile $installerPath

          # Install QGIS LTR with Python packages
          # --quiet-mode: Unattended install
          # --autoaccept: Accept all licenses
          # --no-desktop: Skip desktop shortcuts
          # --arch x86_64: 64-bit installation
          # Packages: qgis-ltr (QGIS Long Term Release with Python/Qt)
          $args = @(
            "--root", "C:\OSGeo4W",
            "--site", "https://download.osgeo.org/osgeo4w/v2",
            "--quiet-mode",
            "--autoaccept",
            "--no-desktop",
            "--arch", "x86_64",
            "--packages", "qgis-ltr"
          )
          Write-Host "Installing OSGeo4W with args: $args"
          Start-Process -FilePath $installerPath -ArgumentList $args -Wait -NoNewWindow

          # Verify installation
          Write-Host "OSGeo4W installation complete"
          if (Test-Path "C:\OSGeo4W\bin\o4w_env.bat") {
            Write-Host "OSGeo4W environment script found"
          } else {
            Write-Error "OSGeo4W installation failed - o4w_env.bat not found"
            exit 1
          }

      - name: Configure OSGeo4W environment
        shell: cmd
        run: |
          :: Initialize OSGeo4W environment
          call C:\OSGeo4W\bin\o4w_env.bat

          :: Verify Python version
          python --version
          python -c "import sys; print(sys.executable)"

          :: Check Qt availability
          python -c "from PyQt5.QtCore import QCoreApplication; print('PyQt5 available')"

      - name: Download latest dev wheel from TestPyPI
        shell: cmd
        run: |
          call C:\OSGeo4W\bin\o4w_env.bat

          :: Install supy from TestPyPI (latest dev version)
          :: Using --pre to get development releases
          pip install --index-url https://test.pypi.org/simple/ --extra-index-url https://pypi.org/simple/ --pre supy

          :: Verify installation
          python -c "import supy; print(f'supy version: {supy.__version__}')"

      - name: Run Qt error handling test
        shell: cmd
        run: |
          call C:\OSGeo4W\bin\o4w_env.bat

          :: Run the Qt error trigger test
          :: This should catch the error as RuntimeError, NOT crash
          python test\qgis\test_qt_error_trigger.py

      - name: Run Qt threaded test
        shell: cmd
        run: |
          call C:\OSGeo4W\bin\o4w_env.bat

          :: Run the threaded Qt test (simulates QGIS worker threads)
          python test\qgis\test_qt_threaded.py

      - name: Test summary
        if: always()
        shell: pwsh
        run: |
          Write-Host "=============================================="
          Write-Host "QGIS Windows Compatibility Test Complete"
          Write-Host "=============================================="
          Write-Host ""
          Write-Host "This test validates that SUEWS errors are handled"
          Write-Host "gracefully in a Qt/QGIS environment on Windows."
          Write-Host ""
          Write-Host "If all tests passed, the f90wrap SIGINT handler fix"
          Write-Host "is working correctly and QGIS will not crash when"
          Write-Host "SUEWS encounters physics errors."
          Write-Host ""
          Write-Host "Related: GH-1035"
