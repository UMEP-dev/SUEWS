name: GitHub Pages Deploy

# UNIFIED GITHUB PAGES DEPLOYMENT
# ===============================
# This workflow handles ALL GitHub Pages content:
# - Site content (landing page, brand assets)
# - Documentation previews (for PRs)
#
# TRIGGER CONDITIONS:
# - Push to master: Deploy to production
# - Pull request: Deploy preview to /preview/pr-{NUMBER}/
# - Manual dispatch: Force regeneration
#
# CONTENT TYPES:
# - site/** → Landing page, brand assets
# - docs/** → Sphinx documentation (PR previews only)
#
# NOTE: Schema hosting removed - validation handled by Pydantic at runtime

on:
  push:
    branches: [master]
    paths:
      - '.github/workflows/pages-deploy.yml'
      - 'site/**'

  pull_request:
    paths:
      - '.github/workflows/pages-deploy.yml'
      - 'site/**'
      - 'docs/**'
      - '.readthedocs.yml'
      - 'pyproject.toml'

  workflow_dispatch:

# Single deployment at a time
concurrency:
  group: pages-deploy
  cancel-in-progress: false

permissions:
  contents: write
  pages: write
  id-token: write
  pull-requests: write

jobs:
  # Detect which content types changed
  detect-changes:
    name: Detect changes
    runs-on: ubuntu-latest
    outputs:
      docs-changed: ${{ steps.filter.outputs.docs }}
      site-changed: ${{ steps.filter.outputs.site }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            docs:
              - 'docs/**'
              - '.readthedocs.yml'
              - 'pyproject.toml'
            site:
              - 'site/**'

  # Build docs if changed (PR only - production uses ReadTheDocs)
  build-docs:
    name: Build documentation
    runs-on: ubuntu-latest
    needs: [detect-changes]
    if: |
      github.event_name == 'pull_request' &&
      needs.detect-changes.outputs.docs-changed == 'true'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - uses: astral-sh/setup-uv@v3

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y gfortran pandoc

      - name: Install package with dev dependencies
        run: uv pip install --system ".[dev]"

      - name: Generate RST from data models
        run: cd docs && make generate-rst

      - name: Build documentation
        run: cd docs && make html

      - name: Upload docs artifact
        uses: actions/upload-artifact@v4
        with:
          name: docs-html
          path: docs/build/html/
          retention-days: 7

  # Deploy all content to GitHub Pages
  deploy:
    name: Deploy to GitHub Pages
    runs-on: ubuntu-latest
    needs: [detect-changes, build-docs]
    # Run even if build-docs was skipped (no docs changes)
    if: |
      always() &&
      (needs.detect-changes.result == 'success' || needs.detect-changes.result == 'skipped') &&
      (needs.build-docs.result == 'success' || needs.build-docs.result == 'skipped')

    environment:
      name: ${{ github.event_name == 'pull_request' && 'github-pages-preview' || 'github-pages' }}
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - uses: actions/checkout@v4

      # Download docs artifact if it was built
      - name: Download docs artifact
        if: needs.build-docs.result == 'success'
        uses: actions/download-artifact@v4
        with:
          name: docs-html
          path: docs-html/

      # Prepare deployment
      - name: Prepare deployment
        env:
          DOCS_BUILT: ${{ needs.build-docs.result == 'success' }}
        run: |
          mkdir -p _site

          if [ "${{ github.event_name }}" = "pull_request" ]; then
            # === PR PREVIEW DEPLOYMENT ===
            # Fetch current production to preserve
            echo "Fetching production content..."
            if timeout 60 wget -q -r -np -nH -P _site https://suews.io/ 2>&1; then
              echo "Fetched production content"
            else
              echo "Could not fetch production (may be empty)"
            fi

            # Prepare preview directory
            PR_NUM="${{ github.event.pull_request.number }}"
            PR_DIR="preview/pr-${PR_NUM}"
            mkdir -p "_site/${PR_DIR}"

            # Copy site content to preview
            if [ -d site ]; then
              cp -r site/* "_site/${PR_DIR}/"
              echo "Site content copied to preview"
            fi

            # Copy docs to preview if built
            if [ "$DOCS_BUILT" = "true" ] && [ -d docs-html ]; then
              mkdir -p "_site/${PR_DIR}/docs"
              cp -r docs-html/* "_site/${PR_DIR}/docs/"
              echo "Docs copied to preview"
            fi

            # Rewrite absolute paths for preview context
            # /brand/ → /preview/pr-N/brand/ so links work within preview
            echo "Rewriting absolute paths for preview..."
            find "_site/${PR_DIR}" -name "*.html" -type f | while read -r f; do
              sed -i "s|href=\"/brand/|href=\"/preview/pr-${PR_NUM}/brand/|g" "$f"
              sed -i "s|href=\"/\"|href=\"/preview/pr-${PR_NUM}/\"|g" "$f"
              # If docs were built, rewrite docs.suews.io links to preview docs
              if [ "$DOCS_BUILT" = "true" ]; then
                sed -i "s|https://docs.suews.io|/preview/pr-${PR_NUM}/docs|g" "$f"
              fi
            done

            # Inject preview banner into site pages
            # Banner is fixed at top with links to production and PR
            PREVIEW_BANNER='<div id="preview-banner" style="background:linear-gradient(90deg,#ffeb3b,#ffc107);color:#333;padding:10px 20px;text-align:center;font-family:system-ui,-apple-system,sans-serif;font-size:13px;position:fixed;top:0;left:0;right:0;z-index:9999;box-shadow:0 2px 8px rgba(0,0,0,0.15);"><strong>Preview - PR #'"${PR_NUM}"'</strong> \&nbsp;\| <a href="https://suews.io/" style="color:#1565c0;text-decoration:underline;">Production</a> \&nbsp;\| <a href="https://github.com/UMEP-dev/SUEWS/pull/'"${PR_NUM}"'" style="color:#1565c0;text-decoration:underline;">View PR</a></div><style>body{padding-top:40px !important;}</style>'

            for page in index.html brand/index.html brand/brand-workshop.html brand/suews-logo-source.html; do
              target="_site/${PR_DIR}/${page}"
              if [ -f "$target" ]; then
                sed -i "s|<body>|<body>${PREVIEW_BANNER}|g" "$target"
                sed -i "s|<body |<body>${PREVIEW_BANNER}<body-placeholder |g" "$target"
                sed -i "s|<body-placeholder |<div |g" "$target"
                echo "Injected preview banner into ${page}"
              fi
            done

            # Inject preview banner into docs pages (if docs were built)
            if [ "$DOCS_BUILT" = "true" ] && [ -d "_site/${PR_DIR}/docs" ]; then
              DOCS_BANNER='<div id="preview-banner" style="background:linear-gradient(90deg,#ffeb3b,#ffc107);color:#333;padding:8px 16px;text-align:center;font-family:system-ui,-apple-system,sans-serif;font-size:12px;position:fixed;top:0;left:0;right:0;z-index:9999;box-shadow:0 2px 8px rgba(0,0,0,0.15);"><strong>Docs Preview - PR #'"${PR_NUM}"'</strong> \&nbsp;\| <a href="https://docs.suews.io/" style="color:#1565c0;text-decoration:underline;">Production docs</a> \&nbsp;\| <a href="https://github.com/UMEP-dev/SUEWS/pull/'"${PR_NUM}"'" style="color:#1565c0;text-decoration:underline;">View PR</a></div><style>.bd-header{top:32px !important;}.bd-sidebar-primary{top:calc(var(--pst-header-height) + 32px) !important;}</style>'

              echo "Injecting preview banner into docs pages..."
              find "_site/${PR_DIR}/docs" -name "*.html" -type f | while read -r f; do
                sed -i "s|<body>|<body>${DOCS_BANNER}|g" "$f"
                sed -i "s|<body |<body>${DOCS_BANNER}<body-placeholder |g" "$f"
                sed -i "s|<body-placeholder |<div |g" "$f"
              done
              echo "Docs preview banner injected"
            fi

            # Ensure production landing exists
            if [ -f site/index.html ] && [ ! -f _site/index.html ]; then
              cp site/index.html _site/index.html
            fi

          else
            # === PRODUCTION DEPLOYMENT (master) ===
            if [ -d site ]; then
              cp -r site/* _site/
              echo "Site contents deployed"
            fi

            if [ ! -f _site/index.html ]; then
              cat > _site/index.html << 'FALLBACK'
          <!DOCTYPE html>
          <html>
          <head>
              <title>SUEWS</title>
              <meta charset="utf-8">
              <meta http-equiv="refresh" content="0; url=https://docs.suews.io/">
          </head>
          <body>
              <p>Redirecting to <a href="https://docs.suews.io/">documentation</a>...</p>
          </body>
          </html>
          FALLBACK
            fi
          fi

          touch _site/.nojekyll

      - uses: actions/configure-pages@v5
      - uses: actions/upload-pages-artifact@v3
        with:
          path: _site
      - uses: actions/deploy-pages@v4
        id: deployment

      # Comment preview URLs on PR
      - name: Comment preview URL
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        env:
          DOCS_BUILT: ${{ needs.build-docs.result == 'success' }}
        with:
          script: |
            const prNumber = context.issue.number;
            const baseUrl = 'https://suews.io';
            const docsBuilt = process.env.DOCS_BUILT === 'true';

            let body = `## Preview Deployed

            **Preview URLs:**
            - Landing: ${baseUrl}/preview/pr-${prNumber}/
            - Brand: ${baseUrl}/preview/pr-${prNumber}/brand/`;

            if (docsBuilt) {
              body += `
            - Docs: ${baseUrl}/preview/pr-${prNumber}/docs/`;
            }

            body += `

            **Production URLs (unchanged):**
            - Site: ${baseUrl}/
            - Docs: https://docs.suews.io`;

            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber
            });

            const botComment = comments.data.find(c =>
              c.user.type === 'Bot' && c.body.includes('Preview Deployed')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body
              });
            }
