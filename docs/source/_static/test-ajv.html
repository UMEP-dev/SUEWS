<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AJV Form Validation App</title>
    <!-- Load browser-compatible version of Ajv -->
    <script src="https://cdn.jsdelivr.net/npm/ajv@6.12.6/dist/ajv.min.js"></script>
    <!-- Add loading indicator -->
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }

        .error {
            color: red;
            margin: 5px 0;
            padding: 5px;
            border-left: 3px solid red;
        }

        input:invalid {
            border-color: red;
            background-color: #fff0f0;
        }
        .input-wrapper {
            position: relative;
            margin-bottom: 10px;
        }
        .input-error {
            color: red;
            font-size: 0.8em;
            margin-top: 2px;
            padding: 2px 5px;
        }

        #debug-panel {
            margin-top: 20px;
            padding: 15px;
            background-color: #f5f5f5;
            border-radius: 4px;
            border: 1px solid #ddd;
        }

        #debug-panel > div {
            margin-bottom: 15px;
            padding: 10px;
            background: white;
            border-radius: 3px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        #debug-panel pre {
            background-color: #f8f8f8;
            padding: 10px;
            border-radius: 3px;
            border: 1px solid #ddd;
            margin: 5px 0;
            white-space: pre-wrap;
        }

        #validation-status {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 3px;
            font-weight: bold;
        }

        #loading-indicator {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>

<body>
    <!-- Add loading indicator -->
    <div id="loading-indicator">
        <div>
            <div class="spinner"></div>
            <p>Initializing validation...</p>
        </div>
    </div>

    <h1>Real-time Numeric Validation</h1>

    <form id="my-form">
        <div>
            <label for="field1">Field 1 (1 to 10): </label>
            <input type="text" id="field1" name="field1">
        </div>
        <div>
            <label for="field2">Field 2 (-5 to 5): </label>
            <input type="text" id="field2" name="field2">
        </div>
        <div id="validation-errors" class="error"></div>
    </form>

    <div id="debug-panel">
        <h3>Debug Information</h3>
        <div>
            <strong>Current Form Data:</strong>
            <pre id="current-data"></pre>
        </div>
        <div>
            <strong>Validation Status:</strong>
            <span id="validation-status"></span>
        </div>
        <div>
            <strong>Raw Validation Errors:</strong>
            <pre id="raw-errors"></pre>
        </div>
        <div>
            <strong>Schema:</strong>
            <pre id="schema-display"></pre>
        </div>
    </div>

    <script>
        // Function to check if Ajv is loaded
        function checkAjvLoaded(maxAttempts = 5) {
            let attempts = 0;

            return new Promise((resolve, reject) => {
                function check() {
                    attempts++;
                    console.log('Checking Ajv availability, attempt:', attempts);

                    if (typeof window.Ajv === 'function') {
                        console.log('Ajv loaded successfully');
                        resolve(window.Ajv);
                    } else if (attempts >= maxAttempts) {
                        console.error('Failed to load Ajv');
                        reject(new Error('Failed to load Ajv after multiple attempts'));
                    } else {
                        console.log('Ajv not loaded yet, retrying...');
                        setTimeout(check, 100);
                    }
                }
                check();
            });
        }

        // Initialize the form once Ajv is loaded
        checkAjvLoaded()
            .then(() => {
                console.log('Starting form initialization');
                // Remove loading indicator
                document.getElementById('loading-indicator').style.display = 'none';

                // Your existing initialization code
                const schema = {
                    type: "object",
                    properties: {
                        field1: { type: "number", minimum: 1, maximum: 10 },
                        field2: { type: "number", minimum: -5, maximum: 5 }
                    },
                    required: ["field1", "field2"]
                };

                // Display schema
                document.getElementById('schema-display').textContent = JSON.stringify(schema, null, 2);

                // Initialize Ajv with options
                const ajv = new window.Ajv({
                    allErrors: true,
                    verbose: true,
                    $data: true
                });

                const validate = ajv.compile(schema);

                const form = document.getElementById("my-form");
                const field1 = document.getElementById("field1");
                const field2 = document.getElementById("field2");
                const errorContainer = document.getElementById("validation-errors");
                const currentDataDisplay = document.getElementById("current-data");
                const validationStatusDisplay = document.getElementById("validation-status");
                const rawErrorsDisplay = document.getElementById("raw-errors");

                // Wrap inputs in div for error messages
                [field1, field2].forEach(field => {
                    const wrapper = document.createElement('div');
                    wrapper.className = 'input-wrapper';
                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'input-error';
                    field.parentNode.insertBefore(wrapper, field);
                    wrapper.appendChild(field);
                    wrapper.appendChild(errorDiv);
                });

                function validateInput(input) {
                    const errorDiv = input.nextElementSibling;
                    const value = input.value.trim();

                    // Clear previous error
                    errorDiv.textContent = "";
                    input.setCustomValidity("");

                    // Handle empty input
                    if (value === "") {
                        return null;
                    }

                    // Check if it's a valid number
                    if (!/^-?\d*\.?\d+$/.test(value)) {
                        errorDiv.textContent = `${input.id}: should be number`;
                        input.setCustomValidity("Invalid number");
                        return null;
                    }

                    const num = Number(value);
                    const fieldName = input.id;
                    const constraints = schema.properties[fieldName];

                    if (num < constraints.minimum || num > constraints.maximum) {
                        const message = `Number must be between ${constraints.minimum} and ${constraints.maximum}`;
                        errorDiv.textContent = message;
                        input.setCustomValidity(message);
                        return null;
                    }

                    return num;
                }

                function runValidation() {
                    const formData = {
                        field1: validateInput(field1),
                        field2: validateInput(field2)
                    };

                    // Always show current form data with type information
                    const formDataStr = JSON.stringify(formData, null, 2);
                    const typeInfo = Object.entries(formData)
                        .map(([key, value]) => `${key}: ${typeof value} (${value})`)
                        .join('\n');
                    currentDataDisplay.textContent = `Form Data:\n${formDataStr}\n\nInput Types:\n${typeInfo}`;

                    const valid = validate(formData);

                    // Always show validation status
                    const statusText = valid ? "✅ Valid" : "❌ Invalid";
                    const details = valid ? "" : " - Found validation errors";
                    validationStatusDisplay.innerHTML = `${statusText}${details}`;
                    validationStatusDisplay.style.backgroundColor = valid ? "#e6ffe6" : "#ffe6e6";
                    validationStatusDisplay.style.padding = "5px 10px";
                    validationStatusDisplay.style.borderRadius = "3px";

                    // Always show validation result
                    if (!valid) {
                        // Format validation errors for better readability
                        const formattedErrors = validate.errors
                            .filter(err => err.keyword !== 'required' || !err.params || !err.params.missingProperty)
                            .map(err => {
                                const field = (err.dataPath || '').replace(/^\./, '') ||
                                             (err.params && err.params.missingProperty);
                               const fieldLabel = field === 'field1' ? 'Field 1' : 'Field 2';
                                const value = formData[field];
                                const constraints = schema.properties[field];

                                return {
                                    field,
                                    fieldLabel,
                                    error: err.message,
                                    currentValue: value,
                                    allowedRange: constraints ? `${constraints.minimum} to ${constraints.maximum}` : 'N/A'
                                };
                            });

                        console.log('Raw validation errors:', validate.errors);
                        console.log('Formatted errors:', formattedErrors);

                        // Format for raw error display
                        const errorDisplay = formattedErrors.map(err => {
                            const parts = [];
                            parts.push(`Field: ${err.fieldLabel}`);
                            parts.push(`Error: ${err.error}`);

                            if (err.currentValue !== undefined && err.currentValue !== null) {
                                parts.push(`Current Value: ${err.currentValue}`);
                            }

                            if (err.allowedRange !== 'N/A') {
                                parts.push(`Allowed Range: ${err.allowedRange}`);
                            }

                            return parts.join('\n');
                        }).join('\n\n');

                        rawErrorsDisplay.textContent = errorDisplay;

                        // Show user-friendly error messages in a more concise format
                        const errorMessages = formattedErrors
                            .map(err => {
                                let msg = `${err.fieldLabel}: ${err.error}`;
                                if (err.currentValue !== undefined && err.currentValue !== null) {
                                    msg = `${msg} (Current: ${err.currentValue}`;
                                    if (err.allowedRange !== 'N/A') {
                                        msg = `${msg}, Allowed: ${err.allowedRange}`;
                                    }
                                    msg = `${msg})`;
                                }
                                // Return each error as an HTML list item
                                return `<li>${msg}</li>`;
                            })
                            // No newline separator because we now have <li></li> items
                            .join("");

                        // Use innerHTML to insert the list structure
                        errorContainer.innerHTML = `<ul>${errorMessages}</ul>`;
                        errorContainer.style.display = 'block';
                    } else {
                        rawErrorsDisplay.textContent = "✅ All validations passed\nAll values are within their allowed ranges.";
                        errorContainer.textContent = "";
                        errorContainer.style.display = 'none';
                    }
                }

                // Set initial values and trigger validation
                field1.value = field1.value || "";
                field2.value = field2.value || "";

                // Run initial validation
                runValidation();

                // Add input event listeners
                [field1, field2].forEach(field => {
                    field.addEventListener("input", runValidation);
                });
            })
            .catch(error => {
                console.error('Detailed error:', error);
                // Show error in debug panel
                document.getElementById('loading-indicator').style.display = 'none';
                document.getElementById('debug-panel').innerHTML = `
                    <div class="error" style="padding: 20px;">
                        <h3>⚠️ Validation Initialization Error</h3>
                        <p>${error.message}</p>
                        <p>Technical details have been logged to the console (F12)</p>
                        <p>This might be because:</p>
                        <ul>
                            <li>The network connection is not available</li>
                            <li>The CDN is not accessible</li>
                            <li>The browser's security settings are blocking script execution</li>
                        </ul>
                        <p>Alternative options:</p>
                        <ul>
                            <li>Try refreshing the page</li>
                            <li>Check if you can access <a href="https://cdn.jsdelivr.net/npm/ajv@6.12.6/dist/ajv.min.js" target="_blank">the Ajv library directly</a></li>
                        </ul>
                    </div>
                `;
            });
    </script>

</body>

</html>